
var
   	 sax = require("sax")
    ,EventEmitter = require('events').EventEmitter
;

module.exports = function (stream) {
    var xmlns = [];
    var xml = sax.createStream(true);

    function getXmlNs(n) {
        if (!n) n = '';

        for (var i = 0; i < xmlns.length; i++) if (xmlns[i]) {
            if (xmlns[i][n]) return xmlns[i][n];
        }
        return null;
    }

    function parseTag(tag) {
        if (tag) {
            if (typeof (tag) != 'object') tag = { name: tag + '' };
            var m;
            if (m = tag.name.match(/^([^:]+):(.*)$/)) {
                tag.localName = m[2];
                tag.xmlns = getXmlNs(m[1]);
            } else {
                tag.localName = tag.name;
                tag.xmlns = getXmlNs('');
            }
        }
        return tag;
    }


    var ee = new EventEmitter()

    ee.parseTag = parseTag;

    xml.on('opentag', function (t) {
        var xmlnsT = null;
        for (var i in t.attributes) if (i.match(/^xmlns/)) {
            if (!xmlnsT) xmlnsT = {};
            xmlnsT[i.replace(/^xmlns(:|$)/, '')] = t.attributes[i];
        }
        xmlns.unshift(xmlnsT);

        ee.emit('opentag', parseTag(t));
    });


    xml.on( 'closetag', function( ) {
        xmlns.shift();
        ee.emit('closetag');
    });

    xml.on('text', function (text) {
        ee.emit('text', text);
    });

    xml.on('end', function () {
        ee.emit('end');
    });

    stream.pipe(xml);
    return ee;
}